```{r setup}
# library(pals)
library(jsonlite)
library(blg)
library(rvest)
library(tidyverse)
library(httr)
library(extrafont); loadfonts("win", quiet = TRUE)
library(magick)
library(sf)

`%not_in%` <- compose(`!`, `%in%`)

load("~/R/oil/data/maps/offshore/offshore.RData")
load("~/R/oil/data/maps/us/states_map.RData")

scrape <- TRUE
```

```{r}
# List of categories
cats <- list(
 crude_oil_production = 296686,  # All states, monthly bpd
 production_by_api = 2477496  # All states, monthly bpd
)

# Possible categories
# 236392  # Supply and disposition summary

# Possible series
# PET.WCRFPUS2.W  # Weekly US Field Production
# PET.WCRNTUS2.W  # Weekly US Net Oil Imports
# PET.WTTNTUS2.W  # Weekly US Net Oil and Petroleum Products Imports
# PET.ESM_EPC0_RAIL_NUS-NUS_MBBL.M  # Monthly US Oil Rail Shipments
```

```{r import_oil_production_meta, include=FALSE, eval=scrape}
# ----
# Set query
# ----

api_url <- "http://api.eia.gov/"
req_cat <- "category/"
api_key_eia  <- getOption("api_key_eia")

url <- parse_url(api_url)
url$path  <- file_path(url$path, req_cat)

# ----
# Make request
# ----

meta <- cats %>%
 map(function(x, u) {
  u$query <- list(api_key = api_key_eia, category_id = x)
  u <- build_url(u)
 }, u = url) %>%
 map(read_html) %>%
 map(html_text) %>%
 map(fromJSON)

meta <- meta %>%
 map(purrr::pluck, "category") 

meta_meta <- meta %>%
 map(~{.x[names(.x) %not_in% "childseries"]})

meta <- meta %>%
 map(purrr::pluck, "childseries") %>%
 map(as_tibble) %>%
 map(~filter(.x, f == "M" & units == "Thousand Barrels per Day"))

meta_series <- meta %>%
 map(pull, "series_id") %>%
 map2(meta %>% map(pull, "name"), set_names)
```

```{r import_oil_production_data, include=FALSE, eval=scrape}
# ----
# Set query
# ----

req_srs <- "/series/"
qry_srs <- "&series_id="

reqs <- meta_series %>%
 map(function(x, u) {
  map(x, ~{
   u$path  <- file_path(req_srs)
   u$query <- list(api_key = api_key_eia,
                   series_id = .x)
   build_url(u)
  })
 }, u = url)


# ----
# Make request
# ----

prod_api <- map(reqs,
                ~map(.x, ~fromJSON(html_text(read_html(.x))))
                )
```


```{r tidy-import-data, eval=scrape}
prod_api_meta <- prod_api %>%
    modify_depth(2, purrr::pluck, "series") %>%
    modify_depth(2, function(x) x[, names(x) %not_in% "data"]) %>%
    map(bind_rows) %>%
    map(as_tibble)

prod_api <- prod_api %>%
    modify_depth(2, purrr::pluck, "series") %>%
    modify_depth(2, function(x) x[, names(x) %in% "data"]) %>%
    modify_depth(3, as_tibble) %>%
    modify_depth(2, bind_rows) %>%
    modify_depth(1, bind_rows, .id = "location")

# Separate 'location' column into two parts: 'location' and 'type'
prod_api$production_by_api <- prod_api$production_by_api %>%
 separate(location, c("location", "type"), " Crude Oil and Lease Condensate Production for ")

# Eliminate uneeded meta information in 'location'
prod_api$crude_oil_production <- prod_api$crude_oil_production %>%
 mutate(location = str_replace(location, " Crude Oil Production, Monthly", ""),
        location = str_replace(location, " Field Production of Crude Oil, Monthly", ""))
prod_api$production_by_api <- prod_api$production_by_api %>%
 mutate(type = str_replace(type, ", Monthly", ""))

# Correct misworded 'type'
prod_api$production_by_api <- prod_api$production_by_api %>%
    mutate(type = if_else(grepl("ULL", type), "50.1 or Higher  Degrees API Gravity", type))

# Rename and convert 'V1'
prod_api <- prod_api %>%
 map(~{
  .x %>%
   rename(date = V1, prod = V2) %>%
   mutate(date = as.Date(paste0(date, "01"), "%Y%m%d"),
          prod = as.integer(prod))
  })
```

```{r save-data, eval=scrape}
save(prod_api, file = "~/R/oil/data/prod/prod_api.RData")
```

```{r load-data, eval=TRUE}
load("~/R/oil/data/prod/prod_api.RData")
```


```{r analysis-data}
# Remove PADD's, US, regions, etc
cop <- prod_api$crude_oil_production %>%
    filter(!grepl("PADD|U\\.S\\.|Alaska North|Alaska South", location))

# Extract US total production
uscop <- prod_api$crude_oil_production %>%
    filter(grepl("U\\.S\\.", location))
```


```{r}
# List of top 5 producers
top_5 <- "Texas|New Mexico|Oklahoma|North Dakota|Federal Offshore"

# Create table of bottom 17
bot_17 <- cop %>%
    filter(!grepl(top_5, location)) %>%
    group_by(date = date) %>%
    summarize(prod = sum(prod, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(location = "Bottom 17")

# Group: Texas, Top 4 After Texas, Rest of US (Bottom 17)
cop_three <- cop %>%
 filter(grepl(top_5, location)) %>%
 filter(date >= as.Date("1981-01-01")) %>%
 group_by(location = location == "Texas", date = date) %>%
 summarize(prod = sum(prod, na.rm = TRUE)) %>%
 ungroup() %>%
 mutate(location = if_else(location == TRUE, "Texas", "Top Four After Texas")) %>%
 bind_rows(bot_17) %>%
 mutate(location = factor(location, rev(c("Bottom 17", "Top Four After Texas", "Texas")), ordered = TRUE),
        prod = prod / 1000)

# Create labels
cop_three_labs <-  cop_three %>%
 filter(date == max(date)) %>%
 arrange(desc(prod)) %>%
 mutate(location = factor(location, location, ordered = TRUE))

# Add custom labels
cop_three_labs <- cop_three_labs %>%
 mutate(pct = prod / sum(prod),
        lab = paste0(location, "\n", scales::percent(pct)))

# For stacked area chart
cop_three_labs$prod <- cop_three_labs$prod + c(3.4, -0.550, -1.05)

p1 <- cop_three %>%
 ggplot(aes(x = date, y = prod, fill = location)) +
 geom_area(aes(color = location), position = "stack") +
 geom_text(aes(label = lab), cop_three_labs, hjust = 1, nudge_x = -90, color = "white", size = 5) +
 scale_x_date(NULL, expand = expand_scale(), limits = as.Date(c("1981-01-01", max(cop$date)))) +
 scale_y_continuous(NULL, expand = expand_scale(), breaks = c(0, 2, 4, 6, 8, 10), limits = c(0, 11)) +
 scale_fill_manual(values = pals::brewer.pubu(10)[c(8,7,6)], guide = FALSE) +
 scale_color_manual(values = pals::brewer.pubu(10)[c(8,7,6)], guide = FALSE) +
 labs(title = "Texas Produces More Than The Next Four States",
      subtitle = "Million Barrels Per Day",
      NULL) +
 theme_classic(base_family = "Lato", base_size = 18) +
 theme(text = element_text(color = "white"),
       plot.background = element_rect(fill = "gray20", color = "gray20"),
       strip.text = element_text(color = "white"),
       axis.line = element_line(color = "white"),
       axis.text = element_text(color = "white"), 
       axis.ticks = element_line(color = "white"),
       panel.background = element_rect(fill = "gray20", color = "gray20"),
       plot.caption = element_text(color = "gray50"))

ggsave("~/R/oil/scripts/report_misc/imgs/prod-1.png", p1, width = 7, height = 5, dpi = 600)
x1 <- image_read("~/R/oil/scripts/report_misc/imgs/prod-1.png")
x1 %>%
 image_resize("x500") %>%
 image_write("~/R/oil/scripts/report_misc/imgs/prod-1-resized.png")
```

```{r}
papi <- prod_api$production_by_api %>%
 filter(location != "Lower 48 States") %>%
 filter(!grepl("all API", type)) %>%
 group_by(date, type, is_texas = location == "Texas") %>%
 summarize(prod = sum(prod)) %>%
 mutate(percent = prod / sum(prod)) %>%
 ungroup() %>%
 mutate(prod = prod / 1000,
        loc = if_else(is_texas == TRUE, "Texas", "All Others"))

papi_lab <- papi %>% 
 filter(date == max(date)) %>%
 mutate(lab = paste0(loc, " (", scales::percent(percent), ")"))

papi_lab$prod <- papi_lab$prod + c(0, 0.4, 0, -0.75, 1, -1.5, 0.5, -0.1)

p2 <- papi %>%
 ggplot(aes(date, prod)) +
 geom_area(aes(group = is_texas, fill = is_texas), position = "stack") +
 geom_text(aes(label = lab), papi_lab, hjust = 1, nudge_x = -7, size = 5, color = "white") +
 facet_wrap(vars(type)) +
 scale_x_date(NULL, expand = expand_scale()) +
 scale_y_continuous(NULL, expand = expand_scale(), labels = scales::comma) +
 scale_fill_manual(values = pals::brewer.greens(9)[c(6, 7)], guide = FALSE) +
 labs(title = "Most Texas Oil Is Light To Very Light Oil",
      # title = "US Oil Production By API Gravity",
      subtitle = "Million Barrels Per Day",
      # caption = "Source: US Energy Information Administration",
      NULL) +
 theme_classic(base_family = "Lato", base_size = 18) +
 theme(text = element_text(color = "white"),
       plot.background = element_rect(fill = "gray20", color = "gray20"),
       strip.text = element_text(color = "white"),
       axis.line = element_line(color = "white"),
       axis.text = element_text(color = "white"),
       axis.ticks = element_line(color = "white"),
       panel.background = element_rect(fill = "gray20", color = "gray20"),
       plot.caption = element_text(color = "gray50"),
       strip.background = element_blank(), 
       panel.spacing.x = unit(0.8, "cm"), plot.margin = margin(l = 1.15, r = 0.60, unit = "lines")) 

ggsave("~/R/oil/scripts/report_misc/imgs/prod-2.png", p2, width = 7, height = 5, dpi = 600)
x2 <- image_read("~/R/oil/scripts/report_misc/imgs/prod-2.png")
x2 %>%
 image_resize("x500") %>%
 image_write("~/R/oil/scripts/report_misc/imgs/prod-2-resized.png")
```


```{r}
new_offshore <- offshore %>%
 filter(region != "pac" & region != "ak") %>%
 group_by(region) %>%
 summarize() %>%
 ungroup() 

new_offshore <- new_offshore %>%
 mutate(region = if_else(region == "gom", "Federal Offshore--Gulf of Mexico", "Alaska")) %>%
 rename(location = region)

new_states_map <- states_map %>%
 select(NAME) %>%
 rename(location = NAME) %>%
 rbind(new_offshore)

new_states_map %>%
    anti_join(cop %>%
                  filter(date == max(date)), ., by = "location")

cop %>%
 filter(date == max(date)) %>%
 left_join(new_states_map, ., by = "location")

p3 <- cop %>%
 filter(date == max(date)) %>%
 mutate(prod = prod / 1000) %>%
 left_join(new_states_map, ., by = "location") %>%
 ggplot() +
 geom_sf(aes(fill = prod), color = "gray20") +
 # scale_fill_viridis_c("Million Barrels Per Day") +
 scale_fill_gradientn("Million Barrels Per Day", colours = pals::brewer.reds(5), na.value = "gray50") +
 guides(fill = guide_colorbar(title.position = "top", barwidth = unit(12.65, "cm"), barheight = unit(0.2, "cm"))) +
 coord_sf(datum = NA, crs = st_crs(102003)) +
 labs(title = "Texas Is Leader Of The Pack In US Oil Production",
      caption = "Source: US Energy Information Administration \nNote: State offshore production included with respective states.") +
 theme_void(base_size = 10, base_family = "Lato") +
 theme(text = element_text(color = "white"),
       plot.background = element_rect(fill = "gray20", color = "gray20"),
       strip.text = element_text(color = "white"),
       axis.line = element_line(color = "white"),
       axis.text = element_text(color = "white"),
       axis.ticks = element_line(color = "white"),
       panel.background = element_rect(fill = "gray20", color = "gray20"),
       plot.caption = element_text(color = "gray50"),
       legend.direction = "horizontal",
       legend.position = "top")

ggsave("~/R/oil/scripts/report_misc/imgs/prod-3.png", p3, width = 5, height = 5, dpi = 600)
x3 <- image_read("~/R/oil/scripts/report_misc/imgs/prod-3.png")
x3 %>%
 image_resize("x500") %>%
 image_write("~/R/oil/scripts/report_misc/imgs/prod-3-resized.png")
```


```{r}
x1 %>%
 image_join(x2) %>%
 image_append(stack = TRUE) %>%
 image_resize("x700") %>%
 image_join(x3 %>%
             image_crop("x2900") %>%
             image_crop("x2800+0-100") %>%
             image_resize("x700"), .) %>%
 image_append(stack = FALSE) %>%
 image_write("~/R/oil/scripts/report_misc/imgs/texas-summary.png")
```

![](C:/Users/Luke/R/oil/scripts/report_misc/imgs/texas-summary.png)
